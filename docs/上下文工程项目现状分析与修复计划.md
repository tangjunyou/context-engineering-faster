# 上下文工程项目现状分析与修复计划

本文档用于沉淀本仓库的现状评估、问题清单、修复方案、测试策略与验收标准。后续更新以追加方式记录，避免信息在对话中丢失。

## 项目概览

- 前端：Vite + React + TypeScript（Vite root 为 `client/`，产物输出到 `dist/public`）
- 后端：Rust（Axum）用于静态托管与少量 API
- WASM：`context-engine` Rust crate 通过 wasm-bindgen 产物供前端调用
- 部署：Dockerfile + docker-compose，目标是 Windows/macOS 均可用 Docker 运行

## 当前关键结论

### Docker 是否已具备部署准备

- 已具备基础 Docker 部署：存在 Dockerfile 与 docker-compose；后端绑定 `0.0.0.0`；镜像运行时包含 Rust 二进制与前端静态资源。
- 需要补齐一项关键一致性保障：Docker 构建链路目前不会校验 WASM 产物是否与源码匹配（仓库存在两份 wasm 产物时尤其关键）。

## 问题清单（按优先级）

### P0：Docker 构建链路缺少 WASM 一致性校验

- 现状：仓库同时存在 `client/src/lib/wasm` 与 `context-engine/pkg` 两份 wasm 产物；本地/CI 的 `pnpm build` 会运行一致性校验脚本，但 Dockerfile 未执行且未拷贝 `context-engine/pkg`，导致校验无法发生。
- 风险：镜像可构建成功，但线上使用的 wasm 可能与 Rust 源码不一致。

### P0：静态服务的关键响应头缺少测试锁定

- 现状：后端已实现 `.wasm` MIME 覆写、缓存策略、SPA fallback、gzip 压缩。
- 风险：后续改动容易回归（例如 `.wasm` Content-Type 被破坏导致浏览器降级/失败；缓存策略失效导致性能问题）。

### P1：前端预览链路的性能与稳定性风险

- 现状：每次生成预览都会创建新的 `ContextEngine` 实例且未显式释放；token 估算在主线程执行且在依赖变更时频繁触发；拓扑排序遇到循环依赖时仅 console warn。
- 风险：长时间使用可能出现内存增长；大图/大文本/大量节点时 UI 卡顿；循环依赖对用户不可见，导致“结果不对但不知道原因”。

### P1：OAuth 回调路径存在前后端不一致

- 现状：前端存在 `/api/oauth/callback` 回调地址拼接，但后端未实现该 API。
- 风险：若开启相关环境变量或入口，线上会直接 404。

## 修复方案（测试先行）

### 1) Docker 构建阶段强制 WASM 一致性校验

- Dockerfile 前端构建阶段拷贝 `scripts/` 与 `context-engine/pkg/` 并执行 `verify-wasm-sync.ts`，校验通过后再构建前端。
- CI 增加容器启动与资源校验：启动容器后验证 `/api/healthz`、SPA fallback、并动态定位 `.wasm` 文件检查其 `Content-Type`。

### 2) Rust 侧补测试锁定静态服务行为

- 新增/扩展 `server-rs` 的集成测试，覆盖：
  - `.wasm` 响应头 `Content-Type: application/wasm`
  - `/assets/*` 的 `Cache-Control` 为 long-term immutable
  - fallback 的 `index.html` 为 `no-cache`

### 3) 前端预览链路：WASM 复用 + debounce + 循环依赖提示

- WASM：
  - 复用 `ContextEngine` 实例，并在组件卸载时调用 `free()` 释放（wasm-bindgen 导出类具备 `free()`）。
  - 延迟初始化：首次需要生成预览时再 init wasm，减少首屏成本。
- 性能：
  - 预览生成与 token 估算加 debounce，避免频繁阻塞主线程。
- 体验：
  - 检测到循环依赖时提供可见提示（Toast/Alert），必要时高亮相关节点。

### 4) OAuth 回调：移除死代码或补齐最小实现

- 若近期不做鉴权：隔离入口，避免误用；或在 UI 层只在环境变量齐全时启用。
- 若要做鉴权：后端补齐回调处理与 cookie 策略，并补测试。

## 验收标准

### 自动化测试

- `cargo test --manifest-path server-rs/Cargo.toml` 覆盖静态服务关键头部与 fallback 行为。
- 前端 Vitest 覆盖预览生成的 debounce、循环依赖提示、WASM 释放行为（通过 mock wasm 模块断言）。

### Docker/CI

- Docker 镜像构建阶段强制运行 WASM 一致性校验。
- CI 在 docker build 后启动容器并验证：
  - `GET /api/healthz` 返回 200
  - `GET /some/route` 返回 200 且为 index fallback
  - `.wasm` 文件响应头 `Content-Type: application/wasm`

### 端到端（Chrome DevTools MCP）

- Console：无 error；WASM 加载成功。
- Network：
  - `.wasm` 为 `application/wasm`
  - `index.html` 为 `no-cache`
  - `/assets/*` 为 long-term cache + immutable
- 功能回归：编辑节点后预览更新；循环依赖时出现可见提示；生成预览不明显卡顿。

