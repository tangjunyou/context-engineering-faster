# 变量执行规范（测试文档）

本文档定义变量的类型系统、执行语义、错误映射与 Trace 字段要求，用于后端执行器与前端观测一致性验收。

## 变量类型（第一阶段）

- `static`：直接由用户提供值，不执行外部 I/O。
- `template`：由模板表达式生成（仅插值，不访问外部）。
- `derived`：依赖其他变量的派生变量（纯计算）。
- `sql`：对某个 SQL 数据源执行查询，返回表格/JSON（第二阶段落地）。
- `cypher`：对 Neo4j 执行 Cypher（扩展阶段）。
- `vector`：对 Milvus 执行向量写入/搜索（扩展阶段）。
- `chat`：从对话记录中抽取（第三阶段落地）。

## 执行语义（必须满足）

### 1) 依赖与求值顺序

- 执行器必须构建变量依赖图并拓扑排序。
- 变量求值必须满足：先求值依赖，再求值当前变量。
- 存在环：必须报告错误，并阻止产出“成功结果”。Trace 必须包含环的相关变量列表。

### 2) 缓存与刷新（第一阶段最小要求）

- `manual`：仅在用户显式触发时求值。
- `on-run`：每次“生成上下文”都会求值。
- `ttl`：在 TTL 未过期时可复用缓存结果（第二阶段增强）。

### 3) 输出形态（第一阶段）

- `string`：可直接插入节点内容。
- `json`：在 Trace 中可视化；插值时默认转为 JSON 字符串（后续可配置序列化风格）。

## Trace 字段要求（变量级）

一次执行中，每个变量必须产出一条或多条事件，至少包含：

- `variable_id`、`name`、`kind`
- `status`：`ok` / `error` / `skipped`
- `started_at`、`ended_at`、`duration_ms`
- `inputs`：关键配置（脱敏）
- `output_preview`：受限长度的输出预览（避免把大结果塞进前端）
- `error`：错误类型与用户可读信息（若有）

## 错误映射（必须用户可定位）

- `invalid_config`：配置缺失或非法（例如缺连接 URL）。
- `connect_failed`：无法建立连接（网络/鉴权/证书）。
- `query_failed`：查询执行失败（语法/权限/超时）。
- `result_too_large`：超过行数/大小限制。
- `dependency_cycle`：依赖成环。

## 最小验收用例（自动化）

### Case V1：静态变量插值

- 变量：`name=Alice`
- 节点模板：`Hello {{name}}`
- 期望：Trace 显示变量事件 `ok`；节点 segment 的 `missing_variables` 为空。

### Case V2：缺失变量定位

- 变量：空
- 节点模板：`Hello {{name}}`
- 期望：Trace 显示节点 segment 的 `missing_variables=["name"]`；全局无 panic。

