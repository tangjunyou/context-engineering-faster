# 安全与资源限制规范（测试文档）

本文档定义连接器与执行器在安全、资源控制与可观测方面的硬性要求，并作为 CI/验收标准的一部分。

## 总原则

- 默认最小权限：能只读就只读；能限制就限制。
- 默认可观测：任何失败都必须在 Trace 中可解释、可定位。
- 默认可控：每个外部 I/O 都必须有超时、大小与并发限制。

## SQL 连接器安全规范（第二阶段落地时必须满足）

### 1) 只读默认

- 默认只允许只读查询（SELECT）。
- 允许用户显式打开写权限时，必须给出风险提示，并可在项目级配置中统一禁用写入。

### 2) 超时与并发

- 连接超时、查询超时必须可配置，且有合理默认值。
- 每个数据源必须有连接池上限与并发上限。

### 3) 结果集限制

- 默认限制最大行数与最大响应大小。
- 超出限制时返回 `result_too_large`，并在 Trace 中记录被截断信息。

### 4) 脱敏与日志

- 任何 Trace/日志中不得出现明文密码、token、私钥。
- 连接 URL 在 Trace 中仅允许保留 scheme/host/dbname，敏感字段必须遮蔽。

## 图/向量连接器安全规范（扩展阶段）

- Neo4j：同样要求超时、并发限制与脱敏；默认只读模式（如可行）。\n- Milvus：对 insert/search 等操作要限制批大小与 payload；搜索结果数量必须有上限。

## SSRF 与外部网络访问

- 若应用运行在用户本机或内网环境，默认允许用户配置数据源；但必须提供：\n  - 明确的允许列表/阻止列表配置选项；\n  - 明确的错误信息（被策略拒绝）。\n\n## 验收用例（自动化优先）\n\n- SQL：超过行数限制返回 `result_too_large`，且 Trace 中包含限制阈值。\n- 超时：人为设置极短超时，必须返回 `query_failed`（timeout），且不会卡死进程。\n- 脱敏：Trace 的连接配置中不出现密码明文。\n\n*** End Patch"}}
