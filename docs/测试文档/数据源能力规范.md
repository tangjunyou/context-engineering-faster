# 数据源能力规范（SQL / Neo4j / Milvus）

本文档定义“用户在平台内管理与使用数据源”的能力边界与验收点，确保用户不需要离开平台就能完成变量抽取规则的配置与验证。

## 总体要求
- 所有数据源均支持：创建、更新、删除、连接测试。
- 所有敏感信息必须加密存储并在 API 响应中脱敏（例如 URL/Token/Password）。
- 数据源能力在 UI 中必须可发现：用户不需要手写协议字符串（例如 neo4j://、milvus://）才能配置变量。

## SQL（MySQL / PostgreSQL / SQLite）
### 必需能力（MVP）
- 浏览：schema、table、column（至少 table/column）。
- 查询：只读查询（SELECT/WITH），支持 rowLimit，上限必须 clamp。
- 变量模板：从表/列生成查询模板（SELECT ... AS value）。

### 可用能力（增强）
- 示例：提供常见查询模板（按主键、按时间范围、分页）。
- 参数化：允许 UI 生成参数化查询并保存为变量规则。
- 结果预览：展示 rows 与自动提取 value 的规则。

## Neo4j
### 必需能力（MVP）
- 浏览：labels、relationship types、property keys（可逐步补齐，但需至少 labels）。
- 变量抽取：Cypher 执行并输出 value（约定 RETURN ... AS value）。
- 参数化：支持 params，禁止拼接注入。

### 可用能力（增强）
- 示例：提供常见 Cypher 模板（按 label、按关系、按属性过滤）。
- 输出：支持 Map/List 输出并序列化为 JSON 字符串。
- 限制：超时、最大行数、最大输出字节、并发限制。

## Milvus（社区版）
### 必需能力（MVP）
- 浏览：collections list。
- 写入：insert（至少支持写入一条或小批次）。
- 抽取：search/query（至少支持一种）。
- 鉴权：支持 Bearer token。

### 可用能力（增强）
- collection 管理：create（含 schema/indexParams）、drop（可选）。
- partitions：create/list/drop（可选但建议）。
- load/release：避免“未 load 导致 search 不可用”的可见性问题。
- 删除：entities delete（按 filter/id）。

### 完整能力（长尾）
- 受控 raw op：白名单端点/限制 body 大小/超时/脱敏；用于覆盖不常用但必须支持的 Milvus REST v2 能力。

## 统一错误码与可观测性（验收契约）
- 所有数据源测试接口必须返回稳定错误码：invalid_config、connect_failed、timeout、feature_not_enabled、limit_exceeded。
- 变量测试与预览 trace 必须包含：
  - dataSourceId、driver、op 摘要
  - clamp 信息（limit/topK/rowLimit）
  - 失败原因与回退行为（例如变量回退为占位符）

## 测试落点建议（用于映射到 CI）
- PR 必跑：SQL（sqlite）+ 数据源脱敏 + 只读限制 + feature gate 契约测试。
- Nightly：MySQL/Postgres/Neo4j/Milvus 容器化回归，覆盖浏览+抽取+删除等关键能力。

