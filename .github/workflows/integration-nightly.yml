name: integration-nightly

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  sqlx-any:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: mysql
          MYSQL_DATABASE: test
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping -h 127.0.0.1 -uroot -pmysql"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 30
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run connector smoke tests
        env:
          TEST_POSTGRES_URL: postgres://postgres:postgres@127.0.0.1:5432/postgres
          TEST_MYSQL_URL: mysql://root:mysql@127.0.0.1:3306/test
        run: cargo test --manifest-path server-rs/Cargo.toml --test sql_any_integration
      - name: Run preview rows smoke tests
        env:
          TEST_POSTGRES_URL: postgres://postgres:postgres@127.0.0.1:5432/postgres
          TEST_MYSQL_URL: mysql://root:mysql@127.0.0.1:3306/test
        run: cargo test --manifest-path server-rs/Cargo.toml --test sql_preview_any_integration
